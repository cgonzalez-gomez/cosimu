nb_ent <- 100
p_up <- 0.1
p_down <- 0.1

prop_sm_up <- c(0.5,0.3,0.2)
prop_sm_down <- c(0.5,0.3,0.2)

shapes <- c(4,7,12)
scale <- 0.3
qf_vect_up <- purrr::map(
  shapes,
  function(shape) {
    local(function(x) {
      p <- parent.env(environment())
      p$shape <- shape
      p$scale_r <- scale
      qgamma(x,shape,scale = scale)
    })
  }
)
qf_vect_nr <- list(
  function(x) qnorm(x,0,0.15)
)
qf_vect_down <- purrr::map(
  shapes,
  function(shape) {
    local(function(x) {
      p <- parent.env(environment())
      p$shape <- shape
      p$scale <- scale
      -qgamma(x,shape,scale = scale)
    })
  }
)
qf_list <- list(qf_vect_up, qf_vect_nr, qf_vect_down)

mod_transition <- "default"
connectivity_score <- 0.9
nr_noise <- 0.02

submod_transition <- "cop"
copula_submod <- "Frank"
rho_submod <- 0.9
eps_submod <-1e-3
optim_method_submod <- "Brent"

proba_transition <- "cop"
copula_prob <- "Frank"
theta_prob <- 10
RNGkind("L'Ecuyer-CMRG")


#######
set.seed(123)
S1 <- PrimarySignatureObj$new(nb_ent = nb_ent, p_up = p_up, p_down = p_down,
                              prop_sm_up = prop_sm_up,
                              prop_sm_down = prop_sm_down,
                              qf_vect_up = qf_vect_up,
                              qf_vect_nr = qf_vect_nr,
                              qf_vect_down = qf_vect_down)

# expected
mod1 <- c(2, 2, 2, 2, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 3, 2, 2, 2, 2, 2, 2, 2, 2, 2, 1, 2, 2, 3, 2, 2, 2, 2, 1, 2, 3, 3, 3, 2, 2, 2, 1, 2, 2, 2, 2, 2, 2, 2
          , 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 3, 1, 2, 2, 2, 3, 2, 1, 2, 2, 2, 2, 2, 2, 1, 2, 2, 1, 2, 2, 2, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 1, 2, 2, 2, 2, 1)
submod1 <- c(1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 3, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 1, 1, 1, 1, 2, 1, 1, 3, 3, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1
             , 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 3, 2, 1, 1, 1, 3, 1, 1, 1, 1, 1, 1, 1, 1, 2, 1, 1, 3, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1)
proba1 <- c(0.392745819, 0.256880473, 0.890858345, 0.531105833, 0.086806715, 0.407155547, 0.374162209, 0.556607608
            , 0.130596124, 0.539579700, 0.853605014, 0.430865312, 0.150041409, 0.270252157, 0.867456228, 0.217542725
            , 0.297897691, 0.454000951, 0.500452133, 0.027106363, 0.109044820, 0.978810128, 0.331412879, 0.251808526
            , 0.108479003, 0.943088138, 0.516837682, 0.921032533, 0.214185116, 0.500839490, 0.348689214, 0.022609745
            , 0.228961680, 0.004945046, 0.780306757, 0.663922724, 0.752539519, 0.587206581, 0.413739472, 0.077495992
            , 0.261482394, 0.538016452, 0.048755198, 0.249552521, 0.058509450, 0.327575340, 0.270183307, 0.028063877
            , 0.382860082, 0.949167502, 0.633311487, 0.929375668, 0.553192240, 0.885950726, 0.805838296, 0.244618473
            , 0.520192922, 0.336194810, 0.889634250, 0.902651423, 0.506871136, 0.708812504, 0.934532944, 0.313244519
            , 0.503385716, 0.644870787, 0.780282086, 0.907705126, 0.124676817, 0.490664557, 0.805815092, 0.360630374
            , 0.714430220, 0.769798015, 0.256597696, 0.192144098, 0.530115655, 0.857115070, 0.711532804, 0.918108846
            , 0.135930558, 0.798651259, 0.356153113, 0.139569868, 0.840330381, 0.422152739, 0.396972986, 0.804162351
            , 0.443099878, 0.916085835, 0.424774608, 0.636201965, 0.834731953, 0.972353425, 0.116340466, 0.879398024
            , 0.687059762, 0.789734282, 0.300139728, 0.075550094)
lfc1 <- c(-0.0408254357, -0.0979489141 , 0.1846658643 , 0.0117074897 , 0.4969815233, -0.0352302179, -0.0481274304
          , 0.0213560649, -0.1685366455 , 0.0149062372 , 0.1578031315, -0.0261257364, -0.1554383709, -0.0918075823
          , 0.1671670239, -0.1170778496, -0.0795684922, -3.3836999641 , 0.0001699995, -0.2887699451, -0.1847435723
          , 0.3044657643, -0.0654022683, -0.1003214143, -0.1851986225 , 0.2371856379 , 0.0063327522 , 2.1163545875
          , -0.1187975415 , 0.0003156438, -1.7157487436, -0.3003910475, -0.1113405999, -0.3869472775 , 0.1159844467
          , 2.3454648609 , 0.1023754465, -1.2321896872, -3.2824235809, -2.2409897104, -0.0958172933 , 0.0143156696
          , -0.2485567365 , 0.7599721778, -0.2351114929, -0.0669927453, -0.0918388041, -0.2865063615, -0.0446966589
          , 0.2455252176 , 0.0510955193 , 0.2206735493 , 0.0200596066 , 0.1807907092 , 0.1293992792, -0.1037284468
          , 0.0075956673, -0.0634306010 , 0.1836877989 , 0.1945212451 , 0.0025836354, -4.0932699974 , 3.4038225526
          , -0.0730011711 , 0.0012730248 , 0.0557263556, -4.3516469624 , 0.1990132463 , 0.5689093150, -0.0035103933
          , 0.1293866221, -0.0535161509 , 0.0849561012 , 0.1107272726, -0.0980805398 , 1.4028139094 , 0.0113340889
          , 0.1601171083 , 4.1022927139 , 0.2088694151, -0.1648180047 , 0.1255220052 , 0.9045326954, -0.1623380808
          , 0.1493724977, -0.0294583934, -0.0391785033 , 0.1284874735, -0.0214671747 , 0.2068823201, -0.0284540437
          , 0.0522487601 , 0.1459551934 , 0.2874848301 , 0.5540340695 , 0.1757974234 , 0.0731299895 , 0.1208249401
          , -0.0785998024 , 0.4728213898)

# Secondary signature
set.seed(100)
S2 <- SecondarySignatureObj$new(
  prim_sig_obj = S1, mod_transition = mod_transition,
  connectivity_score = connectivity_score, nr_noise = nr_noise,
  submod_transition = submod_transition, prop_sm_up = prop_sm_up,
  prop_sm_down = prop_sm_down,
  rho_submod = rho_submod, copula_submod = copula_submod,
  eps_submod = eps_submod, optim_method_submod = optim_method_submod,
  proba_transition = proba_transition,
  copula_prob = copula_prob,theta_prob = theta_prob,
  qf_vect_up = qf_vect_up, qf_vect_nr = qf_vect_nr, qf_vect_down = qf_vect_down)


mod2 <- c(2, 2, 2, 2, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 3, 2, 2, 2, 2, 2, 2, 2, 2, 2, 1, 2, 2, 3, 2, 2, 2, 2, 1, 2, 3, 3, 1, 2, 2, 2, 1, 2, 2, 2, 2, 2, 2, 2
          , 2, 2, 1, 2, 2, 2, 2, 2, 2, 2, 3, 2, 2, 2, 2, 3, 2, 1, 2, 2, 2, 2, 2, 2, 1, 2, 2, 1, 2, 2, 2, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 1, 2, 2, 2, 2, 1)
submod2 <- c(1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 3, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 1, 1, 1, 1, 2, 1, 1, 3, 3, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1
             , 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 3, 1, 1, 1, 1, 3, 1, 1, 1, 1, 1, 1, 1, 1, 2, 1, 1, 3, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1)
proba2 <- c(0.48048048,0.16616617,0.99499499,0.53753754,0.18018018,0.63263263,0.63863864
            ,0.70670671,0.38638639,0.13913914,0.78878879,0.52052052,0.41341341,0.11711712
            ,0.86786787,0.12112112,0.22222222,0.56156156,0.26526527,0.06406406,0.19719720
            ,0.92092092,0.55255255,0.05105105,0.08808809,0.67367367,0.62962963,0.76376376
            ,0.46846847,0.44944945,0.38838839,0.04904905,0.29729730,0.09609610,0.70370370
            ,0.84184184,0.80680681,0.56056056,0.09309309,0.06206206,0.43143143,0.27827828
            ,0.02102102,0.36736737,0.04404404,0.22222222,0.26526527,0.02302302,0.33633634
            ,0.90690691,0.48948949,0.97797798,0.62762763,0.82482482,0.62362362,0.18618619
            ,0.79679680,0.38538539,0.90090090,0.94194194,0.65665666,0.70970971,0.92792793
            ,0.32732733,0.41141141,0.62262262,0.60960961,0.68868869,0.07807808,0.75075075
            ,0.83583584,0.49949950,0.63763764,0.70270270,0.66066066,0.20520521,0.59059059
            ,0.82282282,0.84784785,0.91891892,0.18718719,0.84984985,0.19519520,0.14214214
            ,0.63763764,0.62462462,0.55055055,0.79079079,0.43943944,0.96896897,0.87987988
            ,0.62262262,0.71871872,0.87187187,0.08008008,0.76676677,0.78378378,0.45945946
            ,0.17117117,0.14614615)
lfc2 <- c(-0.0073421577,-0.1454140061 ,0.3863224986 ,0.0141347888 ,0.6592866095 ,0.0508251103 ,0.0532233447 ,0.0815683702,-0.0433124852
          ,-0.1626292736 ,0.1203338525 ,0.0077190030,-0.0328159603,-0.1784283324 ,0.1674553335,-0.1754100997,-0.1147064511,-3.6612992276
          ,-0.0940794536,-0.2282287586,-0.1277512785 ,0.2116939905 ,0.0198169535,-0.2452120452,-0.2028934146 ,0.0675120218 ,0.0496308858
          ,1.5642576957,-0.0118680450,-0.0190578650,-1.7900842605,-0.2481217180,-0.0798284596,-0.1956182106 ,0.0802624223 ,2.8771079448
          ,0.1299283878,-1.1908682418,-2.3174611976 ,2.1549569385,-0.0259096524,-0.0881945777,-0.3049655628 ,0.9195534910,-0.2558355651
          ,-0.1147064511,-0.0940794536,-0.2992456456,-0.0633724159 ,0.1982918761,-0.0039523487 ,0.3020507109 ,0.0488364849 ,1.7243162160
          ,0.0472517585,-0.1338057538 ,0.1245351236,-0.0437050264 ,0.1930052903 ,0.2356929746 ,0.0605033315,-4.0962400252 ,0.2190796773
          ,-0.0670957921,-0.0335873697 ,0.0468564065,-3.7928001313 ,0.0738205234 ,0.4783955323 ,0.1015281222 ,0.1466229840,-0.0001881854
          ,0.0528227095 ,0.0798284596 ,0.0621400295 ,1.4314061985 ,0.0343596684 ,0.1389264486 ,4.6585175102 ,0.2096754793,-0.1332464017
          ,0.1553684433 ,0.6819129433,-0.1606116896 ,0.0528227095 ,0.0476474390 ,0.0190578650 ,0.1213752262,-0.0228585884 ,0.2798778136
          ,0.1761579787 ,0.0468564065 ,0.0868559157 ,0.1702926314 ,0.4827459181 ,0.1092360533 ,0.1177554075,-0.0152693399,-0.1424320905
          ,0.6054115867)


test_that("Primary modality works", {
  expect_equal(S1$get_modality_obj()$get_values(),mod1)
})

test_that("Primary submodality works", {
  expect_equal(S1$get_submodality_obj()$get_values(),submod1)
})

test_that("Primary probabilities works", {
  expect_equal(all(abs(S1$get_probability_obj()$get_values()-proba1)<1e-8),
               TRUE)
})

test_that("Primary lfc works", {
  expect_equal(all(abs(S1$get_lfc_vect()-lfc1)<1e-9),
               TRUE)
})

test_that("Secondary modality works", {
  expect_equal(S2$get_modality_obj()$get_values(),mod2)
})

test_that("Secondary submodality works", {
  expect_equal(S2$get_submodality_obj()$get_values(),submod2)
})

test_that("Secondary probabilities works", {
  expect_equal(all(abs(S2$get_probability_obj()$get_values()-proba2)<1e-8),
               TRUE)
})

test_that("Secondary lfc works", {
  expect_equal(all(abs(S2$get_lfc_vect()-lfc2)<1e-9),
               TRUE)
})

################
submod_transition <- "stochastic"

set.seed(100)
S2 <- SecondarySignatureObj$new(
  prim_sig_obj = S1, mod_transition = mod_transition,
  connectivity_score = connectivity_score, nr_noise = nr_noise,
  submod_transition = submod_transition, prop_sm_up = prop_sm_up,
  prop_sm_down = prop_sm_down,
  rho_submod = rho_submod, copula_submod = copula_submod,
  eps_submod = eps_submod, optim_method_submod = optim_method_submod,
  proba_transition = proba_transition,
  copula_prob = copula_prob,theta_prob = theta_prob,
  qf_vect_up = qf_vect_up, qf_vect_nr = qf_vect_nr, qf_vect_down = qf_vect_down)

lfc2 <- c(-0.0073421577 ,-0.1454140061 ,0.3863224986 ,0.0141347888 ,0.6592866095 ,0.0508251103 ,0.0532233447
          ,0.0815683702 ,-0.0433124852 ,-0.1626292736 ,0.1203338525 ,0.0077190030 ,-0.0328159603 ,-0.1784283324
          ,0.1674553335 ,-0.1754100997 ,-0.1147064511 ,-3.6612992276 ,-0.0940794536 ,-0.2282287586 ,-0.1277512785
          ,0.2116939905 ,0.0198169535 ,-0.2452120452 ,-0.2028934146 ,0.0675120218 ,0.0496308858 ,1.5642576957
          ,-0.0118680450 ,-0.0190578650 ,-3.2186248412 ,-0.2481217180 ,-0.0798284596 ,-0.1956182106 ,0.0802624223
          ,2.8771079448 ,0.1299283878 ,-1.1908682418 ,-2.3174611976 ,2.1549569385 ,-0.0259096524 ,-0.0881945777
          ,-0.3049655628 ,0.9195534910 ,-0.2558355651 ,-0.1147064511 ,-0.0940794536 ,-0.2992456456 ,-0.0633724159
          ,0.1982918761 ,-0.0039523487 ,0.3020507109 ,0.0488364849 ,1.7243162160 ,0.0472517585 ,-0.1338057538
          ,0.1245351236 ,-0.0437050264 ,0.1930052903 ,0.2356929746 ,0.0605033315 ,-4.0962400252 ,0.2190796773
          ,-0.0670957921 ,-0.0335873697 ,0.0468564065 ,-3.7928001313 ,0.0738205234 ,0.4783955323 ,0.1015281222
          ,0.1466229840 ,-0.0001881854 ,0.0528227095 ,0.0798284596 ,0.0621400295 ,0.6966948020 ,0.0343596684
          ,0.1389264486 ,4.6585175102 ,0.2096754793 ,-0.1332464017 ,0.1553684433 ,1.4095598869 ,-0.1606116896
          ,0.0528227095 ,0.0476474390 ,0.0190578650 ,0.1213752262 ,-0.0228585884 ,0.2798778136 ,0.1761579787
          ,0.0468564065 ,0.0868559157 ,0.1702926314 ,0.4827459181 ,0.1092360533 ,0.1177554075 ,-0.0152693399
          ,-0.1424320905 ,1.2948602496)

test_that("Stochastic transitions works", {
  expect_equal(all(abs(S2$get_lfc_vect()-lfc2)<1e-9),
               TRUE)
})

################
submod_transition <- "deterministic"
proba_transition <- "deterministic"
set.seed(100)
S2 <- SecondarySignatureObj$new(
  prim_sig_obj = S1, mod_transition = mod_transition,
  connectivity_score = connectivity_score, nr_noise = nr_noise,
  submod_transition = submod_transition, prop_sm_up = prop_sm_up,
  prop_sm_down = prop_sm_down,
  rho_submod = rho_submod, copula_submod = copula_submod,
  eps_submod = eps_submod, optim_method_submod = optim_method_submod,
  proba_transition = proba_transition,
  qf_vect_up = qf_vect_up, qf_vect_nr = qf_vect_nr, qf_vect_down = qf_vect_down)

lfc2 <- c(-0.0408254357, -0.0979489141 , 0.1846658643 , 0.0117074897 , 0.4969815233, -0.0352302179, -0.0481274304
          , 0.0213560649, -0.1685366455 , 0.0149062372 , 0.1578031315, -0.0261257364, -0.1554383709, -0.0918075823
          , 0.1671670239, -0.1170778496, -0.0795684922, -3.3836999641 , 0.0001699995, -0.2887699451, -0.1847435723
          , 0.3044657643, -0.0654022683, -0.1003214143, -0.1851986225 , 0.2371856379 , 0.0063327522 , 2.1163545875
          , -0.1187975415 , 0.0003156438, -1.7157487436, -0.3003910475, -0.1113405999, -0.3869472775 , 0.1159844467
          , 2.3454648609 , 0.1023754465, -1.2321896872, -3.2824235809 , 2.2409897104, -0.0958172933 , 0.0143156696
          , -0.2485567365 , 0.7599721778, -0.2351114929, -0.0669927453, -0.0918388041, -0.2865063615, -0.0446966589
          , 0.2455252176 , 0.0510955193 , 0.2206735493 , 0.0200596066 , 1.9404918335 , 0.1293992792, -0.1037284468
          , 0.0075956673, -0.0634306010 , 0.1836877989 , 0.1945212451 , 0.0025836354, -4.0932699974 , 0.2265642808
          , -0.0730011711 , 0.0012730248 , 0.0557263556, -4.3516469624 , 0.1990132463 , 0.5689093150, -0.0035103933
          , 0.1293866221, -0.0535161509 , 0.0849561012 , 0.1107272726, -0.0980805398 , 1.4028139094 , 0.0113340889
          , 0.1601171083 , 4.1022927139 , 0.2088694151, -0.1648180047 , 0.1255220052 , 0.9045326954, -0.1623380808
          , 0.1493724977, -0.0294583934, -0.0391785033 , 0.1284874735, -0.0214671747 , 0.2068823201, -0.0284540437
          , 0.0522487601 , 0.1459551934 , 0.2874848301 , 0.5540340695 , 0.1757974234 , 0.0731299895 , 0.1208249401
          , -0.0785998024 , 0.4728213898)

test_that("Dependent transitions works", {
  expect_equal(all(abs(S2$get_lfc_vect()-lfc2)<1e-9),
               TRUE)
})

###############
submod_transition <- "independent"
proba_transition <- "independent"
set.seed(100)
S2 <- SecondarySignatureObj$new(
  prim_sig_obj = S1, mod_transition = mod_transition,
  connectivity_score = connectivity_score, nr_noise = nr_noise,
  submod_transition = submod_transition, prop_sm_up = prop_sm_up,
  prop_sm_down = prop_sm_down,
  rho_submod = rho_submod, copula_submod = copula_submod,
  eps_submod = eps_submod, optim_method_submod = optim_method_submod,
  proba_transition = proba_transition,
  qf_vect_up = qf_vect_up, qf_vect_nr = qf_vect_nr, qf_vect_down = qf_vect_down)
lfc2 <- c(-0.027067345, -0.028259168, -0.014209393, -0.283015340 , 1.390674331 , 0.142763300 , 0.186302701
          , 0.055054021 , 0.217441342 , 0.303774894 , 0.020912817, -0.025680302 , 0.223832162 , 0.065724424
          , -0.123931622, -0.019099332, -0.055520153, -1.105369898 , 0.147194548, -0.035669651 , 0.067966596
          , -0.002337961 , 0.149472440 , 0.132491638, -0.151191802 , 0.225989609 , 0.005883892 , 1.690830226
          , 0.218012734, -0.099198772, -1.460502589, -0.064289230, -0.030959048 , 0.040025899, -0.012506112
          , 1.487702788, -0.103771454, -1.277977093, -3.442915460 , 0.807545520 , 0.109246661 , 0.172716454
          , -0.173196367 , 1.269253334, -0.108608223, -0.003982275, -0.353748521, -0.148917507, -0.114238672
          , -0.007725075 , 0.054575926, -0.188968174, -0.054231634 , 1.259678143 , 0.160830686, -0.094750978
          , 0.187227723, -0.092634825, -0.119342877, -0.223723410 , 0.055461314, -0.841611904, -0.057440821
          , -0.195427108, -0.024450830, -0.171515937, -2.770195706 , 0.188235824 , 0.499770209 , 0.171722435
          , -0.203645933 , 0.048641526, -0.031430403, -0.033469187 , 0.318947281 , 1.350035944, -0.080971550
          , -0.039697764 , 1.267793162, -0.056105638 , 0.006792697, -0.121229073 , 3.998447106, -0.125233688
          , 0.176809830 , 0.116964691 , 0.064107848, -0.145036364, -0.332477759, -0.276867555 , 0.366296569
          , -0.207741356 , 0.095653455 , 0.062879999 , 0.247806877 , 0.094700284, -0.018306256 , 0.271377825
          , 0.030185174 , 3.784903799)

test_that("Independent transitions works", {
  expect_equal(all(abs(S2$get_lfc_vect()-lfc2)<1e-9),
               TRUE)
})
